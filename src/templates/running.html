{% extends 'layout.html' %}
{% block content %}
<h3>Running Conversion</h3>
<div class="card">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <div><strong>ID:</strong> <code>{{ item['id'] }}</code></div>
        <div class="text-truncate" style="max-width: 600px;"><strong>Input:</strong> <span class="text-break">{{ item['input'] }}</span></div>
      </div>
      <div>
        <a class="btn btn-secondary" href="{{ url_for('history_detail', item_id=item['id']) }}">Details</a>
      </div>
    </div>
    <hr>
    <div class="mb-2"><strong>Step:</strong> <span id="step">{{ item.get('step', '-') }}</span></div>
    <div class="progress" role="progressbar" aria-label="Progress" aria-valuemin="0" aria-valuemax="100">
      <div id="bar" class="progress-bar" style="width: 0%">0%</div>
    </div>
    <div class="mt-2 text-muted">
      ETA: <span id="eta">-</span>
    </div>
    <form method="post" action="{{ url_for('job_cancel', item_id=item['id']) }}" class="mt-3" onsubmit="return confirm('Cancel this conversion?');">
      <button type="submit" class="btn btn-warning">Cancel</button>
      <a class="btn btn-outline-secondary" href="{{ url_for('history') }}">Back to History</a>
    </form>
  </div>
</div>
<script>
async function poll() {
  try {
    const res = await fetch("{{ url_for('job_status', item_id=item['id']) }}", {cache: 'no-store'});
    const data = await res.json();
    const pct = Math.max(0, Math.min(100, data.progress || 0));
    const bar = document.getElementById('bar');
    bar.style.width = pct + '%';
    bar.textContent = pct.toFixed(0) + '%';
    document.getElementById('step').textContent = data.step || '-';
    const etaSpan = document.getElementById('eta');
    if (data.eta_seconds !== undefined && data.eta_seconds !== null) {
      const secs = Math.max(0, Math.round(data.eta_seconds));
      const mins = Math.floor(secs / 60);
      const rem = secs % 60;
      etaSpan.textContent = (mins > 0 ? mins + 'm ' : '') + rem + 's';
    } else {
      etaSpan.textContent = '-';
    }
    if (["completed","failed","canceled"].includes(data.status)) {
      window.location = "{{ url_for('history_detail', item_id=item['id']) }}";
      return;
    }
  } catch (e) {
    console.error(e);
  }
  setTimeout(poll, 1500);
}
poll();
</script>
{% endblock %}
